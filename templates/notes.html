{% extends "base.html" %} {% block title %}–ú–æ–∏ –∑–∞–º–µ—Ç–∫–∏ - QA Pet Project{%
endblock %} {% block extra_css %}
<style>
  .container {
    max-width: 1200px;
    margin: 20px auto;
    padding: 20px;
    border-radius: 8px;
    background-color: var(--bg-primary);
    box-shadow: var(--shadow);
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--border-light);
  }

  .header h1 {
    color: var(--text-primary);
    margin: 0;
  }

  .header a {
    color: var(--text-primary);
    text-decoration: none;
    margin-left: 15px;
    padding: 8px 16px;
    border-radius: 4px;
    transition: background-color 0.3s ease;
  }

  .header a:hover {
    background-color: var(--bg-tertiary);
  }

  .controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .search-box {
    flex: 1;
    min-width: 200px;
  }

  .filters {
    display: flex;
    gap: 10px;
  }

  input,
  select,
  button {
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 14px;
    background-color: var(--bg-primary);
    color: var(--text-primary);
  }

  input:focus,
  select:focus {
    border-color: var(--btn-primary);
    outline: none;
  }

  button {
    background-color: var(--btn-primary);
    color: white;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  button:hover {
    background-color: var(--btn-primary-hover);
  }

  .notes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }

  .note-card {
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    background-color: var(--bg-primary);
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .note-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
  }

  .note-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 10px;
  }

  .note-title {
    font-weight: bold;
    font-size: 18px;
    color: var(--text-primary);
    margin: 0;
  }

  .note-status {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
  }

  .status-active {
    background-color: var(--success-bg);
    color: var(--success-text);
  }

  .status-completed {
    background-color: var(--info-bg);
    color: var(--info-text);
  }

  .status-archived {
    background-color: var(--error-bg);
    color: var(--error-text);
  }

  .note-content {
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: 10px;
  }

  .note-meta {
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 10px;
  }

  .note-actions {
    display: flex;
    gap: 5px;
  }

  .note-actions button {
    padding: 4px 8px;
    font-size: 12px;
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
  }

  .modal-content {
    background-color: var(--bg-primary);
    margin: 5% auto;
    padding: 20px;
    border-radius: 8px;
    width: 80%;
    max-width: 500px;
    box-shadow: var(--shadow);
  }

  .close {
    color: var(--text-muted);
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }

  .close:hover {
    color: var(--text-primary);
  }

  .form-group {
    margin-bottom: 15px;
  }

  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: var(--text-primary);
  }

  .form-group input,
  .form-group textarea,
  .form-group select {
    width: 100%;
    box-sizing: border-box;
    background-color: var(--bg-primary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
  }

  .form-group textarea {
    height: 100px;
    resize: vertical;
  }

  .loading {
    text-align: center;
    padding: 20px;
    color: var(--text-secondary);
  }

  .cache-info {
    background-color: var(--info-bg);
    color: var(--info-text);
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    margin-bottom: 10px;
    border: 1px solid var(--info-border);
  }
</style>
{% endblock %} {% block content %}
<div class="container">
  <div class="header">
    <h1>–ú–æ–∏ –∑–∞–º–µ—Ç–∫–∏</h1>
    <div>
      <a href="{{ url_for('main.profile') }}">–ü—Ä–æ—Ñ–∏–ª—å</a>
      <a href="{{ url_for('main.logout') }}">–í—ã–π—Ç–∏</a>
    </div>
  </div>

  <div id="message"></div>
  <div id="cacheInfo" class="cache-info" style="display: none"></div>

  <div class="controls">
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–º–µ—Ç–∫–∞–º..." />
    </div>
    <div class="filters">
      <select id="statusFilter">
        <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
        <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
        <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</option>
        <option value="archived">–ê—Ä—Ö–∏–≤–Ω—ã–µ</option>
      </select>
      <select id="sortBy">
        <option value="created_at">–ü–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è</option>
        <option value="updated_at">–ü–æ –¥–∞—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</option>
        <option value="title">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
      </select>
      <select id="sortOrder">
        <option value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
        <option value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
      </select>
      <button onclick="loadNotes()">–û–±–Ω–æ–≤–∏—Ç—å</button>
      <button onclick="clearCache()" class="btn-info">–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à</button>
      <button onclick="showCreateModal()" class="btn-success">
        + –ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞
      </button>
    </div>
  </div>

  <div id="notesContainer">
    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–º–µ—Ç–æ–∫...</div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div id="noteModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2 id="modalTitle">–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞</h2>
    <form id="noteForm">
      <div class="form-group">
        <label for="noteTitle">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
        <input type="text" id="noteTitle" required />
      </div>
      <div class="form-group">
        <label for="noteContent">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:</label>
        <textarea id="noteContent" required></textarea>
      </div>
      <div class="form-group">
        <label for="noteStatus">–°—Ç–∞—Ç—É—Å:</label>
        <select id="noteStatus">
          <option value="active">–ê–∫—Ç–∏–≤–Ω–∞—è</option>
          <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω–∞—è</option>
          <option value="archived">–ê—Ä—Ö–∏–≤–Ω–∞—è</option>
        </select>
      </div>
      <button type="submit" id="submitBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button type="button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <h2>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h2>
    <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–º–µ—Ç–∫—É?</p>
    <button onclick="confirmDelete()" class="btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
    <button onclick="closeDeleteModal()">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  let notes = [];
  let currentNoteId = null;
  let noteToDelete = null;
  let lastEtag = null;

  // –§—É–Ω–∫—Ü–∏–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
  function getCacheKey() {
    const search = document.getElementById("searchInput").value;
    const status = document.getElementById("statusFilter").value;
    const sortBy = document.getElementById("sortBy").value;
    const sortOrder = document.getElementById("sortOrder").value;
    return `notes_${search}_${status}_${sortBy}_${sortOrder}`;
  }

  function saveToCache(data, etag) {
    const cacheKey = getCacheKey();
    const cacheData = {
      data: data,
      etag: etag,
      timestamp: Date.now(),
    };
    localStorage.setItem(cacheKey, JSON.stringify(cacheData));
  }

  function getFromCache() {
    const cacheKey = getCacheKey();
    const cached = localStorage.getItem(cacheKey);
    if (cached) {
      const cacheData = JSON.parse(cached);
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—Å—Ç–∞—Ä–µ–ª –ª–∏ –∫—ç—à (5 –º–∏–Ω—É—Ç)
      if (Date.now() - cacheData.timestamp < 5 * 60 * 1000) {
        return cacheData;
      }
    }
    return null;
  }

  function clearCache() {
    const keys = Object.keys(localStorage);
    keys.forEach((key) => {
      if (key.startsWith("notes_")) {
        localStorage.removeItem(key);
      }
    });
    showMessage("–ö—ç—à –æ—á–∏—â–µ–Ω!", "success");
    loadNotes();
  }

  function showCacheInfo(message) {
    const cacheInfo = document.getElementById("cacheInfo");
    cacheInfo.textContent = message;
    cacheInfo.style.display = "block";
    setTimeout(() => {
      cacheInfo.style.display = "none";
    }, 3000);
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–º–µ—Ç–æ–∫
  async function loadNotes() {
    const search = document.getElementById("searchInput").value;
    const status = document.getElementById("statusFilter").value;
    const sortBy = document.getElementById("sortBy").value;
    const sortOrder = document.getElementById("sortOrder").value;

    const params = new URLSearchParams({
      search: search,
      status: status,
      sort: sortBy,
      order: sortOrder,
    });

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
    const cached = getFromCache();
    if (cached) {
      notes = cached.data;
      lastEtag = cached.etag;
      renderNotes();
      showCacheInfo("üì¶ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫—ç—à–∞");
      return;
    }

    try {
      const headers = {};
      if (lastEtag) {
        headers["If-None-Match"] = lastEtag;
      }

      const response = await fetch(`/api/notes?${params}`, { headers });

      if (response.status === 304) {
        // –î–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à
        const cached = getFromCache();
        if (cached) {
          notes = cached.data;
          renderNotes();
          showCacheInfo("üîÑ –î–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å (–∫—ç—à)");
        }
        return;
      }

      if (response.ok) {
        notes = await response.json();

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
        const etag = response.headers.get("ETag");
        if (etag) {
          saveToCache(notes, etag);
          lastEtag = etag;
          showCacheInfo("üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∫—ç—à");
        }

        renderNotes();
      } else {
        showMessage("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–º–µ—Ç–æ–∫", "error");
      }
    } catch (error) {
      showMessage("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", "error");
    }
  }

  // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–º–µ—Ç–æ–∫
  function renderNotes() {
    const container = document.getElementById("notesContainer");

    if (notes.length === 0) {
      container.innerHTML = '<div class="loading">–ó–∞–º–µ—Ç–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
      return;
    }

    container.innerHTML = `
                <div class="notes-grid">
                    ${notes
                      .map(
                        (note) => `
                        <div class="note-card">
                            <div class="note-header">
                                <h3 class="note-title">${escapeHtml(
                                  note.title
                                )}</h3>
                                <span class="note-status status-${
                                  note.status
                                }">${getStatusText(note.status)}</span>
                            </div>
                            <div class="note-content">${escapeHtml(
                              note.content
                            )}</div>
                            <div class="note-meta">
                                –°–æ–∑–¥–∞–Ω–æ: ${new Date(
                                  note.created_at
                                ).toLocaleDateString()}<br>
                                –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(
                                  note.updated_at
                                ).toLocaleDateString()}
                            </div>
                            <div class="note-actions">
                                <button onclick="editNote(${
                                  note.id
                                })">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                <button onclick="deleteNote(${
                                  note.id
                                })" class="btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                    `
                      )
                      .join("")}
                </div>
            `;
  }

  // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏
  async function createNote(data) {
    try {
      const response = await fetch("/api/notes", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      });

      if (response.ok) {
        showMessage("–ó–∞–º–µ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!", "success");
        closeModal();
        // –û—á–∏—â–∞–µ–º –∫—ç—à –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –∑–∞–º–µ—Ç–∫–∏
        clearCache();
        loadNotes();
      } else {
        const error = await response.json();
        showMessage(error.error, "error");
      }
    } catch (error) {
      showMessage("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏", "error");
    }
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏
  async function updateNote(id, data) {
    try {
      const response = await fetch(`/api/notes/${id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      });

      if (response.ok) {
        showMessage("–ó–∞–º–µ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!", "success");
        closeModal();
        // –û—á–∏—â–∞–µ–º –∫—ç—à –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
        clearCache();
        loadNotes();
      } else {
        const error = await response.json();
        showMessage(error.error, "error");
      }
    } catch (error) {
      showMessage("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏", "error");
    }
  }

  // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏
  async function deleteNote(id) {
    noteToDelete = id;
    document.getElementById("deleteModal").style.display = "block";
  }

  async function confirmDelete() {
    if (!noteToDelete) return;

    try {
      const response = await fetch(`/api/notes/${noteToDelete}`, {
        method: "DELETE",
      });

      if (response.ok) {
        showMessage("–ó–∞–º–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞!", "success");
        closeDeleteModal();
        // –û—á–∏—â–∞–µ–º –∫—ç—à –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏
        clearCache();
        loadNotes();
      } else {
        const error = await response.json();
        showMessage(error.error, "error");
      }
    } catch (error) {
      showMessage("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏", "error");
    }
  }

  // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
  function showCreateModal() {
    currentNoteId = null;
    document.getElementById("modalTitle").textContent = "–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞";
    document.getElementById("noteForm").reset();
    document.getElementById("noteModal").style.display = "block";
  }

  function editNote(id) {
    const note = notes.find((n) => n.id === id);
    if (!note) return;

    currentNoteId = id;
    document.getElementById("modalTitle").textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫—É";
    document.getElementById("noteTitle").value = note.title;
    document.getElementById("noteContent").value = note.content;
    document.getElementById("noteStatus").value = note.status;
    document.getElementById("noteModal").style.display = "block";
  }

  function closeModal() {
    document.getElementById("noteModal").style.display = "none";
  }

  function closeDeleteModal() {
    document.getElementById("deleteModal").style.display = "none";
    noteToDelete = null;
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
  document.getElementById("noteForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const data = {
      title: document.getElementById("noteTitle").value,
      content: document.getElementById("noteContent").value,
      status: document.getElementById("noteStatus").value,
    };

    if (currentNoteId) {
      updateNote(currentNoteId, data);
    } else {
      createNote(data);
    }
  });

  // –°–æ–±—ã—Ç–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
  document
    .getElementById("searchInput")
    .addEventListener("input", debounce(loadNotes, 300));
  document.getElementById("statusFilter").addEventListener("change", loadNotes);
  document.getElementById("sortBy").addEventListener("change", loadNotes);
  document.getElementById("sortOrder").addEventListener("change", loadNotes);

  // –£—Ç–∏–ª–∏—Ç—ã
  function escapeHtml(text) {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  function getStatusText(status) {
    const statuses = {
      active: "–ê–∫—Ç–∏–≤–Ω–∞—è",
      completed: "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω–∞—è",
      archived: "–ê—Ä—Ö–∏–≤–Ω–∞—è",
    };
    return statuses[status] || status;
  }

  function showMessage(text, type) {
    const messageDiv = document.getElementById("message");
    messageDiv.innerHTML = `<div class="${type}">${text}</div>`;
    setTimeout(() => {
      messageDiv.innerHTML = "";
    }, 3000);
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
  window.onclick = function (event) {
    const noteModal = document.getElementById("noteModal");
    const deleteModal = document.getElementById("deleteModal");
    if (event.target === noteModal) {
      closeModal();
    }
    if (event.target === deleteModal) {
      closeDeleteModal();
    }
  };

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–º–µ—Ç–æ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  loadNotes();
</script>
{% endblock %}
