{% extends "base.html" %} {% block title %}–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ - QA
Pet Project{% endblock %} {% block extra_css %}
<style>
  .monitor-container {
    max-width: 1200px;
    margin: 50px auto;
    padding: 20px;
  }

  .monitor-header {
    text-align: center;
    margin-bottom: 40px;
  }

  .monitor-header h1 {
    color: var(--text-primary);
    margin-bottom: 10px;
  }

  .monitor-header p {
    color: var(--text-secondary);
    font-size: 18px;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
  }

  .stat-card {
    background: var(--bg-primary);
    border-radius: 12px;
    padding: 25px;
    box-shadow: var(--shadow);
    text-align: center;
    border: 1px solid var(--border-color);
  }

  .stat-value {
    font-size: 36px;
    font-weight: bold;
    margin-bottom: 10px;
  }

  .stat-label {
    color: var(--text-secondary);
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .stat-good {
    color: var(--success-color);
  }
  .stat-warning {
    color: var(--warning-color);
  }
  .stat-danger {
    color: var(--error-color);
  }

  .performance-section {
    background: var(--bg-primary);
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: var(--shadow);
  }

  .section-title {
    color: var(--text-primary);
    font-size: 24px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .endpoint-list {
    display: grid;
    gap: 15px;
  }

  .endpoint-item {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 20px;
    border: 1px solid var(--border-color);
  }

  .endpoint-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }

  .endpoint-name {
    font-weight: bold;
    color: var(--text-primary);
    font-size: 16px;
  }

  .endpoint-status {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
  }

  .status-good {
    background: var(--success-bg);
    color: var(--success-text);
  }
  .status-warning {
    background: var(--warning-bg);
    color: var(--warning-text);
  }
  .status-danger {
    background: var(--error-bg);
    color: var(--error-text);
  }

  .endpoint-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
  }

  .metric {
    text-align: center;
  }

  .metric-value {
    font-size: 18px;
    font-weight: bold;
    color: var(--text-primary);
  }

  .metric-label {
    font-size: 12px;
    color: var(--text-secondary);
    text-transform: uppercase;
  }

  .load-test-section {
    background: var(--bg-primary);
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: var(--shadow);
  }

  .test-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
  }

  .form-group label {
    margin-bottom: 8px;
    color: var(--text-primary);
    font-weight: bold;
  }

  .form-group input,
  .form-group select {
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-size: 14px;
  }

  .btn {
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    transition: all 0.3s ease;
  }

  .btn-primary {
    background: var(--btn-primary);
    color: white;
  }

  .btn-primary:hover {
    background: var(--btn-primary-hover);
    transform: translateY(-2px);
  }

  .btn-secondary {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
  }

  .btn-secondary:hover {
    background: var(--bg-tertiary);
  }

  .test-results {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
    display: none;
  }

  .test-results.show {
    display: block;
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background: var(--bg-tertiary);
    border-radius: 4px;
    overflow: hidden;
    margin: 10px 0;
  }

  .progress-fill {
    height: 100%;
    background: var(--btn-primary);
    transition: width 0.3s ease;
  }

  .chart-container {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
  }

  .chart {
    width: 100%;
    height: 300px;
    background: var(--bg-primary);
    border-radius: 6px;
    display: flex;
    align-items: end;
    justify-content: space-around;
    padding: 20px;
    gap: 10px;
  }

  .chart-bar {
    background: var(--btn-primary);
    min-width: 30px;
    border-radius: 4px 4px 0 0;
    transition: height 0.3s ease;
    position: relative;
  }

  .chart-label {
    position: absolute;
    bottom: -25px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    color: var(--text-secondary);
    white-space: nowrap;
  }

  .chart-value {
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    color: var(--text-primary);
    font-weight: bold;
  }

  @media (max-width: 768px) {
    .monitor-container {
      margin: 20px;
      padding: 15px;
    }

    .stats-grid {
      grid-template-columns: 1fr;
    }

    .test-controls {
      grid-template-columns: 1fr;
    }

    .endpoint-metrics {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>
{% endblock %} {% block content %}
<div class="monitor-container">
  <div class="monitor-header">
    <h1>üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</h1>
    <p>–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
  </div>

  <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value stat-good" id="uptime">--</div>
      <div class="stat-label">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="requests-per-sec">--</div>
      <div class="stat-label">–ó–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="avg-response-time">--</div>
      <div class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="error-rate">--</div>
      <div class="stat-label">–ü—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫</div>
    </div>
  </div>

  <!-- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ -->
  <div class="performance-section">
    <h2 class="section-title">üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤</h2>
    <div class="endpoint-list" id="endpoint-list">
      <!-- –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>
  </div>

  <!-- –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ -->
  <div class="load-test-section">
    <h2 class="section-title">üî• –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>

    <div class="test-controls">
      <div class="form-group">
        <label for="test-endpoint">–≠–Ω–¥–ø–æ–∏–Ω—Ç:</label>
        <select id="test-endpoint">
          <option value="/">–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</option>
          <option value="/ping">Ping</option>
          <option value="/register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</option>
          <option value="/login">–í—Ö–æ–¥</option>
          <option value="/api/notes">API Notes</option>
        </select>
      </div>

      <div class="form-group">
        <label for="concurrent-users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</label>
        <input
          type="number"
          id="concurrent-users"
          value="5"
          min="1"
          max="100"
        />
      </div>

      <div class="form-group">
        <label for="requests-per-user">–ó–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
        <input
          type="number"
          id="requests-per-user"
          value="10"
          min="1"
          max="1000"
        />
      </div>

      <div class="form-group">
        <label>&nbsp;</label>
        <button class="btn btn-primary" onclick="startLoadTest()">
          üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç
        </button>
      </div>
    </div>

    <div class="test-results" id="test-results">
      <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
      <div class="progress-bar">
        <div class="progress-fill" id="test-progress" style="width: 0%"></div>
      </div>
      <div id="test-status">–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é</div>

      <div class="chart-container">
        <h4>–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (–º—Å)</h4>
        <div class="chart" id="response-time-chart">
          <!-- –ì—Ä–∞—Ñ–∏–∫ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
  let performanceData = {};
  let loadTestRunning = false;

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  document.addEventListener("DOMContentLoaded", function () {
    loadPerformanceData();
    loadEndpointData();

    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    setInterval(loadPerformanceData, 5000);
    setInterval(loadEndpointData, 10000);
  });

  // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  async function loadPerformanceData() {
    try {
      const response = await fetch("/api/performance");
      if (response.ok) {
        const data = await response.json();
        updatePerformanceStats(data);
      }
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:", error);
    }
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
  async function loadEndpointData() {
    try {
      const response = await fetch("/api/endpoints-performance");
      if (response.ok) {
        const data = await response.json();
        updateEndpointList(data);
      }
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤:", error);
    }
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  function updatePerformanceStats(data) {
    document.getElementById("uptime").textContent = data.uptime || "--";
    document.getElementById("requests-per-sec").textContent =
      data.requests_per_sec || "--";
    document.getElementById("avg-response-time").textContent =
      data.avg_response_time || "--";
    document.getElementById("error-rate").textContent = data.error_rate || "--";

    // –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è
    const errorRate = parseFloat(data.error_rate) || 0;
    const errorElement = document.getElementById("error-rate");
    errorElement.className =
      "stat-value " +
      (errorRate < 1
        ? "stat-good"
        : errorRate < 5
        ? "stat-warning"
        : "stat-danger");
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
  function updateEndpointList(data) {
    const container = document.getElementById("endpoint-list");
    container.innerHTML = "";

    data.endpoints.forEach((endpoint) => {
      const item = createEndpointItem(endpoint);
      container.appendChild(item);
    });
  }

  // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞
  function createEndpointItem(endpoint) {
    const item = document.createElement("div");
    item.className = "endpoint-item";

    const statusClass =
      endpoint.avg_response_time < 100
        ? "status-good"
        : endpoint.avg_response_time < 500
        ? "status-warning"
        : "status-danger";

    item.innerHTML = `
        <div class="endpoint-header">
            <div class="endpoint-name">${endpoint.name}</div>
            <div class="endpoint-status ${statusClass}">
                ${
                  endpoint.avg_response_time < 100
                    ? "–û—Ç–ª–∏—á–Ω–æ"
                    : endpoint.avg_response_time < 500
                    ? "–•–æ—Ä–æ—à–æ"
                    : "–ú–µ–¥–ª–µ–Ω–Ω–æ"
                }
            </div>
        </div>
        <div class="endpoint-metrics">
            <div class="metric">
                <div class="metric-value">${endpoint.avg_response_time}–º—Å</div>
                <div class="metric-label">–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</div>
            </div>
            <div class="metric">
                <div class="metric-value">${endpoint.requests_per_sec}</div>
                <div class="metric-label">RPS</div>
            </div>
            <div class="metric">
                <div class="metric-value">${endpoint.success_rate}%</div>
                <div class="metric-label">–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</div>
            </div>
            <div class="metric">
                <div class="metric-value">${endpoint.total_requests}</div>
                <div class="metric-label">–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</div>
            </div>
        </div>
    `;

    return item;
  }

  // –ó–∞–ø—É—Å–∫ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  async function startLoadTest() {
    if (loadTestRunning) {
      alert("–¢–µ—Å—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω!");
      return;
    }

    const endpoint = document.getElementById("test-endpoint").value;
    const concurrentUsers = parseInt(
      document.getElementById("concurrent-users").value
    );
    const requestsPerUser = parseInt(
      document.getElementById("requests-per-user").value
    );

    if (!endpoint || concurrentUsers < 1 || requestsPerUser < 1) {
      alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!");
      return;
    }

    loadTestRunning = true;
    const resultsDiv = document.getElementById("test-results");
    const progressBar = document.getElementById("test-progress");
    const statusDiv = document.getElementById("test-status");

    resultsDiv.classList.add("show");
    statusDiv.textContent = "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...";
    progressBar.style.width = "0%";

    try {
      const response = await fetch("/api/load-test", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          endpoint: endpoint,
          concurrent_users: concurrentUsers,
          requests_per_user: requestsPerUser,
        }),
      });

      if (response.ok) {
        const data = await response.json();
        showLoadTestResults(data);
      } else {
        throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
      }
    } catch (error) {
      statusDiv.textContent = "–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: " + error.message;
    } finally {
      loadTestRunning = false;
    }
  }

  // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  function showLoadTestResults(data) {
    const statusDiv = document.getElementById("test-status");
    const chartDiv = document.getElementById("response-time-chart");

    statusDiv.innerHTML = `
        <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</strong><br>
        ‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: ${data.successful}/${data.total} (${data.success_rate}%)<br>
        ‚è±Ô∏è –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${data.avg_response_time}–º—Å<br>
        üöÄ RPS: ${data.requests_per_sec}<br>
        üì¶ –°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞: ${data.avg_response_size} –±–∞–π—Ç
    `;

    // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
    createResponseTimeChart(data.response_times);
  }

  // –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞
  function createResponseTimeChart(responseTimes) {
    const chartDiv = document.getElementById("response-time-chart");
    chartDiv.innerHTML = "";

    if (!responseTimes || responseTimes.length === 0) {
      chartDiv.innerHTML = "<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞</p>";
      return;
    }

    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º
    const ranges = [
      { min: 0, max: 50, label: "0-50–º—Å" },
      { min: 50, max: 100, label: "50-100–º—Å" },
      { min: 100, max: 200, label: "100-200–º—Å" },
      { min: 200, max: 500, label: "200-500–º—Å" },
      { min: 500, max: 1000, label: "500-1000–º—Å" },
      { min: 1000, max: Infinity, label: ">1000–º—Å" },
    ];

    const counts = ranges.map((range) => {
      return responseTimes.filter(
        (time) => time >= range.min && time < range.max
      ).length;
    });

    const maxCount = Math.max(...counts);

    ranges.forEach((range, index) => {
      const count = counts[index];
      const height = maxCount > 0 ? (count / maxCount) * 200 : 0;

      const bar = document.createElement("div");
      bar.className = "chart-bar";
      bar.style.height = height + "px";

      bar.innerHTML = `
            <div class="chart-value">${count}</div>
            <div class="chart-label">${range.label}</div>
        `;

      chartDiv.appendChild(bar);
    });
  }
</script>
{% endblock %}
